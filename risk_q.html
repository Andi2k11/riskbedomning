<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Underlag för riskbedömning</title>
    <style>
        @page { size: A4; margin: 15mm; }
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        body { font-family: Calibri, Arial, sans-serif; line-height: 1.2; margin: 0; padding: 0; }
        #status-message { background: #fff3cd; color: #856404; padding: 15px; text-align: center; border-bottom: 1px solid #ffeeba; }
        @media print { #status-message { display: none; } }
        [contenteditable="true"]:hover { background-color: #f9f9f9; outline: 1px dashed #4472C4; }
        .logo { height: 25mm; width: auto; display: block; margin-bottom: 5mm; }
        h1, h2 { color: #4472C4; margin: 0 0 5mm 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 5mm; table-layout: fixed; border: 1px solid #4472C4; }
        th, td { border: 1px solid #4472C4; padding: 5px; text-align: left; vertical-align: top; word-wrap: break-word; }
        .header-row { color: #FFFFFF !important; background-color: #4472C4 !important; font-weight: bold; }
        .content-cell-small { font-size: 9pt; }
        .label-cell { background-color: #4472C4 !important; color: #FFFFFF !important; font-weight: bold; font-size: 9pt; }
        .ghs-icon { display: inline-block; width: 12mm; height: 12mm; background-size: contain; background-repeat: no-repeat; margin-right: 1mm; }
        .ghs01 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/4/4a/GHS-pictogram-explos.svg'); }
        .ghs02 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/6/6d/GHS-pictogram-flamme.svg'); }
        .ghs03 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/e5/GHS-pictogram-rondflam.svg'); }
        .ghs04 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/6/6a/GHS-pictogram-bottle.svg'); }
        .ghs05 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/a/a1/GHS-pictogram-acid.svg'); }
        .ghs06 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/58/GHS-pictogram-skull.svg'); }
        .ghs07 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/c/c3/GHS-pictogram-exclam.svg'); }
        .ghs08 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/2/21/GHS-pictogram-silhouette.svg'); }
        .ghs09 { background-image: url('https://upload.wikimedia.org/wikipedia/commons/b/b9/GHS-pictogram-pollu.svg'); }
        ul { margin: 0; padding-left: 15px; }
    </style>
</head>
<body>
    <div id="status-message">Väntar på giltig data...</div>
    <div id="report-content">
        <img src="https://vellinge.se/siteassets/kommun-och-politik/pressrum/vellinge_kommun_logotyp_brakvalitet.png" class="logo">
        <h1>Underlag för riskbedömning</h1>
        <h2 id="display-titel" contenteditable="true">-</h2>
        <table id="tblKemikalier">
            <thead><tr class="header-row"><th>Kemikalier</th><th>Piktogram / Faroangivelse</th><th>Vid incident</th></tr></thead>
            <tbody></tbody>
        </table>
        <table id="tblArbetsmoment">
            <thead><tr class="header-row"><th>Arbetsmoment</th><th>Beskrivning</th><th>Vid incident</th></tr></thead>
            <tbody></tbody>
        </table>
        <table id="tblRiskanalys">
            <thead><tr class="header-row"><th>Riskkälla</th><th>Beskrivning</th><th>S</th><th>K</th><th>Riskvärde</th></tr></thead>
            <tbody></tbody>
        </table>
        <table id="tblOvrigt"></table>
        <table id="tblAnpassning">
            <tr><td class="content-cell-small"><strong>Specifik anpassning:</strong><div contenteditable="true" style="min-height: 20mm;"></div></td></tr>
        </table>
        <table id="tblVem">
            <tr><td class="label-cell">Datum</td><td id="display-datum" contenteditable="true"></td><td class="label-cell">Klass</td><td contenteditable="true"></td><td class="label-cell">Sign</td><td contenteditable="true"></td></tr>
        </table>
    </div>

    <script>
        function createList(items) {
            if (!items || items.length === 0) return `<ul><li></li></ul>`;
            return `<ul>` + items.map(item => `<li>${item}</li>`).join('') + "</ul>";
        }

        function renderPiktogram(piktogramStr) {
            if (!piktogramStr) return "";
            const matches = piktogramStr.match(/GHS0[1-9]/gi);
            return matches ? matches.map(code => `<span class="ghs-icon ${code.toLowerCase()}"></span>`).join('') : "";
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            let dataParam = urlParams.get('data');
            if (!dataParam) return;

            try {
                // TVÄTT: Ta bort ALLA tecken som inte är Base64 (A-Z, 0-9, +, /, =)
                // Detta tar bort de kinesiska tecknen "狂V" automatiskt!
                let cleaned = dataParam.replace(/[^A-Za-z0-9+/=]/g, "");
                
                const binary = atob(cleaned);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                const data = JSON.parse(new TextDecoder().decode(bytes));

                document.getElementById('display-titel').textContent = "- " + (data.TITEL || "");
                document.getElementById('display-datum').textContent = data.DATUM || "";
                
                document.querySelector('#tblKemikalier tbody').innerHTML = (data.KEMIKALIER || []).map(k => `
                    <tr class="content-cell-small">
                        <td contenteditable="true"><strong>${k.KEMIKALIENAMN}</strong></td>
                        <td>${renderPiktogram(k.PIKTOGRAM)}${createList(k.FAROANGIVELSER)}</td>
                        <td contenteditable="true">${createList(k.VID_INCIDENT)}</td>
                    </tr>`).join('');

                document.querySelector('#tblArbetsmoment tbody').innerHTML = (data.ARBETSMOMENT_LISTA || []).map(a => `
                    <tr class="content-cell-small">
                        <td contenteditable="true">${a.ARBETSMOMENT}</td>
                        <td contenteditable="true">${a.BESKRIVNING}</td>
                        <td contenteditable="true">${createList(a.VID_INCIDENT)}</td>
                    </tr>`).join('');

                document.querySelector('#tblRiskanalys tbody').innerHTML = (data.RISK_ANALYS || []).map(r => `
                    <tr class="content-cell-small">
                        <td>${r.RISKKÄLLA}</td><td>${r.BESKRIVNING}</td><td style="text-align:center">${r.SANNOLIKHET}</td><td style="text-align:center">${r.KONSEKVENS}</td><td><strong>${r.RISKVAL}</strong></td>
                    </tr>`).join('');

                const ovr = data.OVRIGT || {};
                document.getElementById('tblOvrigt').innerHTML = `
                    <tr><td class="label-cell">Förebyggande åtgärder</td><td class="content-cell-small">${createList(ovr.FOREBYGGANDE_ATGARDER)}</td></tr>
                    <tr><td class="label-cell">Avfall</td><td class="content-cell-small">${createList(ovr.AVFALLSHANTERING)}</td></tr>`;

                document.getElementById('status-message').style.display = 'none';
            } catch (e) {
                document.getElementById('status-message').innerHTML = "Fel vid inläsning. Kontrollera strängen.";
                console.error(e);
            }
        };
    </script>
</body>
</html>
